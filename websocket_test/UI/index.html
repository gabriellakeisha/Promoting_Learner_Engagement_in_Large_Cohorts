<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lecture Chat Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
           max-width: 480px; margin: 2rem auto; border: 1px solid #ccc; padding: 1rem; }
    h2 { margin: 0 0 .5rem; font-size: 1.1rem; }
    #status { font-size: .9rem; color: #555; margin-bottom: .5rem; }
    #messages { border: 1px solid #999; background: #fafafa; height: 300px; overflow-y: auto;
                padding: .5rem; margin-bottom: .75rem; }
    .msg { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: .5rem .6rem;
           margin-bottom: .5rem; line-height: 1.35; word-break: break-word; }
    .me  { border-color: #a8d5ff; background: #eef7ff; }
    .sys { border-color: #ffd48a; background: #fff7e6; }
    .meta { font-size: .78rem; color: #666; margin-bottom: .2rem; }
    #composer { display: flex; gap: .5rem; }
    #msgInput { flex: 1; padding: .6rem; font-size: 1rem; border: 1px solid #bbb; border-radius: 8px; }
    #sendBtn { padding: .6rem .9rem; font-size: 1rem; border-radius: 8px; border: 1px solid #0d6efd; background: #0d6efd; color: #fff; }
    #sendBtn:disabled { opacity: .6; cursor: not-allowed; }
  </style>
</head>
<body>

  <h2>Lecture Chat Prototype</h2>
  <div id="status">Connecting…</div>
  <div id="messages" aria-live="polite"></div>

  <form id="composer" autocomplete="off">
    <input id="msgInput" type="text" placeholder="Type a message…" maxlength="2000" autofocus />
    <button id="sendBtn" type="submit" disabled>Send</button>
  </form>

  <script>
    // Anonymous per-device ID
    const user = "User-" + Math.floor(Math.random() * 9000 + 1000);

    // Build WS URL from page host (works on localhost or laptop IP)
    const wsURL = (location.protocol === "https:" ? "wss://" : "ws://") + location.host;
    console.log("WS URL:", wsURL);
    const socket = new WebSocket(wsURL);

    const statusEl = document.getElementById("status");
    const messagesEl = document.getElementById("messages");
    const form = document.getElementById("composer");
    const input = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    function setConnected(ok) {
      statusEl.textContent = ok ? `Connected (${user})` : "Disconnected";
      sendBtn.disabled = !ok;
    }

    socket.addEventListener("open",  () => { console.log("WS open"); setConnected(true); });
    socket.addEventListener("close", () => { console.log("WS close"); setConnected(false); });
    socket.addEventListener("error", (e) => { console.log("WS error", e); statusEl.textContent = "Connection error"; });

    // Render ONLY messages coming from server
    socket.addEventListener("message", (event) => {
      console.log("WS message:", event.data);

      // Try JSON first
      try {
        const msg = JSON.parse(event.data);

        if (msg.type === "system") {
          appendMessage({ text: msg.text, cls: "sys" });
          return;
        }
        if (msg.type !== "chat") return;

        const mine = (msg.user === user);
        const time = new Date(msg.ts || Date.now()).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        appendMessage({
          text: msg.text,
          meta: `${msg.user} • ${time}`,
          cls: mine ? "me" : ""
        });
        return;
      } catch {
        // If server ever sent raw text, still show it
        appendMessage({ text: String(event.data) });
      }
    });

    function appendMessage({ text, meta = "", cls = "" }) {
      const wrap = document.createElement("div");
      wrap.className = "msg " + cls;

      if (meta) {
        const m = document.createElement("div");
        m.className = "meta";
        m.textContent = meta;
        wrap.appendChild(m);
      }
      const body = document.createElement("div");
      body.textContent = text;
      wrap.appendChild(body);

      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Send as JSON: {user,text}
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      if (socket.readyState !== WebSocket.OPEN) {
        statusEl.textContent = "Not connected — message not sent";
        return;
      }
      const outbound = JSON.stringify({ user, text });
      console.log("WS send:", outbound);
      socket.send(outbound);

      input.value = "";
      input.focus();
    });

  </script>
</body>
</html>
